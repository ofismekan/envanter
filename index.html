<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stok Y√∂netim Sistemi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border-bottom: 4px solid #667eea;
        }
        .header h1 { color: #2d3748; font-size: 2.5em; margin-bottom: 10px; }
        .header p { color: #718096; font-size: 1.1em; }
        .tabs { display: flex; gap: 10px; margin-top: 20px; }
        .tab-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: #e2e8f0;
            color: #4a5568;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
            transition: transform 0.3s;
            cursor: pointer;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { color: #718096; font-size: 0.9em; margin-bottom: 10px; text-transform: uppercase; }
        .stat-card .value { color: #2d3748; font-size: 2.5em; font-weight: bold; }
        .settings-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .settings-panel h3 { color: #2d3748; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .edit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .edit-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        .edit-item label { font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px; }
        .edit-item input {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            width: 100%;
            font-size: 0.9em;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }
        .btn-primary { background: #667eea; }
        .btn-primary:hover { background: #5a67d8; }
        .btn-success { background: #48bb78; }
        .btn-success:hover { background: #38a169; }
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: white;
        }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f7fafc; }
        th {
            padding: 15px;
            text-align: left;
            font-size: 0.85em;
            color: #4a5568;
            text-transform: uppercase;
            font-weight: 600;
        }
        td { padding: 15px; border-bottom: 1px solid #e2e8f0; }
        tbody tr { cursor: pointer; }
        tbody tr:hover { background: #f7fafc; }
        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            display: inline-block;
        }
        .badge-critical { background: #fed7d7; color: #c53030; }
        .badge-low { background: #feebc8; color: #c05621; }
        .badge-normal { background: #c6f6d5; color: #22543d; }
        .loading { text-align: center; padding: 100px 20px; }
        .loading-spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            background: #fff5f5;
            border: 2px solid #fc8181;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            max-width: 600px;
            margin: 50px auto;
        }
        .hidden { display: none; }
        .location-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .location-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            cursor: pointer;
        }
        .location-card:hover { transform: translateY(-5px); }
        .location-card h3 {
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        .location-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f7fafc;
        }
        .location-item:last-child { border-bottom: none; }
        .location-item .label { color: #718096; }
        .location-item .value { color: #2d3748; font-weight: 600; text-align: right; }
        .critical-badge {
            background: #fed7d7;
            color: #c53030;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 5px;
        }
        .edit-mode { background: #fffde7; }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p style="color: #718096; font-size: 1.2em;">Veriler y√ºkleniyor...</p>
    </div>

    <div id="error" class="error hidden">
        <h2>‚ö†Ô∏è Hata Olu≈ütu</h2>
        <p id="errorMessage">JSON dosyalarƒ± y√ºklenemedi.</p>
        <p style="font-size: 0.9em; margin-top: 20px;">
            Dosyalarƒ±n aynƒ± dizinde olduƒüundan emin olun: envanter.json, cay_kahve.json, envanter_maliyet.json, cay_kahve_maliyet.json
        </p>
    </div>

    <div id="content" class="container hidden">
        <div class="header">
            <h1>üì¶ Stok Y√∂netim Sistemi</h1>
            <p>QUASAR Depo Takip</p>
            <div class="tabs">
                <button class="tab-btn active" onclick="app.switchTab('envanter', event)">Envanter</button>
                <button class="tab-btn" onclick="app.switchTab('cayKahve', event)">√áay & Kahve</button>
            </div>
        </div>

        <div id="envanterTab">
            <div class="stats-grid">
                <div class="stat-card" onclick="app.resetInventoryFilter()">
                    <h3>Toplam √úr√ºn √áe≈üidi</h3>
                    <div class="value" id="totalProducts">0</div>
                </div>
                <div class="stat-card" style="border-left-color: #fc8181;" onclick="app.filterInventory('CRITICAL')">
                    <h3>Kritik Stok Uyarƒ±sƒ±</h3>
                    <div class="value" style="color: #c53030;" id="lowStockCount">0</div>
                </div>
                <div class="stat-card" style="border-left-color: #38b2ac;">
                    <h3>Toplam Envanter Maliyeti</h3>
                    <div class="value" style="font-size: 2em; color: #38b2ac;" id="totalInventoryCost">0‚Ç∫</div>
                </div>
                <div class="stat-card" style="border-left-color: #48bb78;" onclick="app.saveToJSON()">
                    <h3>üíæ Deƒüi≈üiklikleri Kaydet</h3>
                    <div style="font-size: 1.2em; color: #48bb78; font-weight: 600;">JSON ƒ∞ndir</div>
                </div>
            </div>

            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 30px; display: flex; gap: 10px;">
                <input type="text" id="searchInput" placeholder="üîç √úr√ºn ara..." oninput="app.filterInventory('SEARCH')" style="flex-grow: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1em;">
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h2>T√ºm Envanter (D√ºzenlemek i√ßin √ºr√ºne tƒ±klayƒ±n)</h2>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>√úr√ºn Kodu</th>
                                <th>A√ßƒ±klama</th>
                                <th>Depo</th>
                                <th style="text-align: center;">Bakiye</th>
                                <th style="text-align: center;">Birim Maliyet</th>
                                <th style="text-align: center;">Toplam Maliyet</th>
                                <th style="text-align: center;">Kritik Seviye</th>
                                <th style="text-align: center;">Durum</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="cayKahveTab" class="hidden">
            <div class="stats-grid">
                <div class="stat-card" onclick="app.resetCayKahveFilter()">
                    <h3>Toplam Lokasyon</h3>
                    <div class="value" id="totalLocations">0</div>
                </div>
                <div class="stat-card" style="border-left-color: #fc8181;" onclick="app.filterCayKahve('CRITICAL')">
                    <h3>Kritik Lokasyon</h3>
                    <div class="value" style="color: #c53030;" id="criticalLocationCount">0</div>
                </div>
                <div class="stat-card" style="border-left-color: #38b2ac;">
                    <h3>Toplam Maliyet</h3>
                    <div class="value" style="font-size: 2em; color: #38b2ac;" id="totalCayKahveCost">0‚Ç∫</div>
                </div>
                <div class="stat-card" style="border-left-color: #48bb78;" onclick="app.saveToJSON()">
                    <h3>üíæ Deƒüi≈üiklikleri Kaydet</h3>
                    <div style="font-size: 1.2em; color: #48bb78; font-weight: 600;">JSON ƒ∞ndir</div>
                </div>
            </div>

            <div class="settings-panel">
                <h3>üõ†Ô∏è Varsayƒ±lan Ayarlar (T√ºm lokasyonlar i√ßin ge√ßerli)</h3>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="app.saveCayKahveSettings()">Kaydet</button>
                </div>
                <div class="edit-grid" id="cayKahveEditGrid"></div>
            </div>

            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2d3748;">Lokasyon Se√ßin</label>
                <select id="locationSelect" onchange="app.changeLocation()" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1em;">
                    <option value="ALL">T√úM LOKASYONLAR</option>
                </select>
            </div>

            <div id="allLocations" class="location-grid"></div>

            <div id="singleLocation" class="hidden">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Lokasyon Detayƒ±</h2>
                    </div>
                    <div id="locationDetail" style="padding: 25px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const app = {
            data: {
                envanter: null,
                cayKahve: null,
                envanterCost: null,
                cayKahveCost: null,
                products: [],
                currentFilter: 'ALL',
                cayKahveFilter: 'ALL'
            },
            cayKahveProducts: [
                { key: '√áAY', label: '√áAY Miktarƒ±', dateKey: '√áAY Tarih' },
                { key: 'T√úRK KAHVESƒ∞', label: 'T√úRK KAHVESƒ∞ Miktarƒ±', dateKey: 'T√úRK KAHVESƒ∞ Tarih' },
                { key: 'Fƒ∞LTRE KAHVE', label: 'Fƒ∞LTRE KAHVE Miktarƒ±', dateKey: 'Fƒ∞LTRE KAHVE Tarih' },
                { key: '≈ûEKER', label: '≈ûEKER Miktarƒ±', dateKey: '≈ûEKER Tarih' }
            ],
            _editingRow: null,

            async loadData() {
                try {
                    const files = ['envanter.json', 'cay_kahve.json', 'envanter_maliyet.json', 'cay_kahve_maliyet.json'];
                    const responses = await Promise.all(files.map(f => fetch(f)));
                    
                    for (let i = 0; i < responses.length; i++) {
                        if (!responses[i].ok) throw new Error(`${files[i]} y√ºklenemedi (${responses[i].status})`);
                    }

                    const [envanter, cayKahve, envanterCost, cayKahveCost] = await Promise.all(responses.map(r => r.json()));
                    
                    this.data.envanter = envanter;
                    this.data.cayKahve = cayKahve;
                    this.data.envanterCost = envanterCost;
                    this.data.cayKahveCost = cayKahveCost;

                    this.data.products = Object.entries(envanter.envanter_genel).map(([kod, item]) => {
                        const costInfo = envanterCost.urun_ayarlari?.[kod] || { maliyet: 0, kritik_seviye: 10 };
                        return {
                            kod,
                            ...item,
                            maliyet: parseFloat(costInfo.maliyet) || 0,
                            kritikSeviye: parseInt(costInfo.kritik_seviye) || 10,
                            toplamMaliyet: ((item.bakiye || 0) * (parseFloat(costInfo.maliyet) || 0)).toFixed(2)
                        };
                    }).sort((a, b) => a.bakiye - b.bakiye);

                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('content').classList.remove('hidden');
                    
                    this.init();
                } catch (error) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('error').classList.remove('hidden');
                    document.getElementById('errorMessage').textContent = `Hata: ${error.message}`;
                    console.error('Y√ºkleme hatasƒ±:', error);
                }
            },

            init() {
                this.updateStats();
                this.renderInventory();
                this.populateLocationSelect();
                this.renderCayKahveEdit();
                this.renderAllLocations();
            },

            async saveToJSON() {
                try {
                    // Envanter maliyet kaydet
                    const envanterBlob = new Blob([JSON.stringify(this.data.envanterCost, null, 2)], { type: 'application/json' });
                    const envanterUrl = URL.createObjectURL(envanterBlob);
                    const envanterLink = document.createElement('a');
                    envanterLink.href = envanterUrl;
                    envanterLink.download = 'envanter_maliyet.json';
                    envanterLink.click();
                    URL.revokeObjectURL(envanterUrl);

                    await new Promise(resolve => setTimeout(resolve, 100));

                    // √áay kahve maliyet kaydet
                    const cayKahveBlob = new Blob([JSON.stringify(this.data.cayKahveCost, null, 2)], { type: 'application/json' });
                    const cayKahveUrl = URL.createObjectURL(cayKahveBlob);
                    const cayKahveLink = document.createElement('a');
                    cayKahveLink.href = cayKahveUrl;
                    cayKahveLink.download = 'cay_kahve_maliyet.json';
                    cayKahveLink.click();
                    URL.revokeObjectURL(cayKahveUrl);

                    await new Promise(resolve => setTimeout(resolve, 100));

                    // √áay kahve stok ge√ßmi≈üi kaydet
                    const cayKahveDataBlob = new Blob([JSON.stringify(this.data.cayKahve, null, 2)], { type: 'application/json' });
                    const cayKahveDataUrl = URL.createObjectURL(cayKahveDataBlob);
                    const cayKahveDataLink = document.createElement('a');
                    cayKahveDataLink.href = cayKahveDataUrl;
                    cayKahveDataLink.download = 'cay_kahve.json';
                    cayKahveDataLink.click();
                    URL.revokeObjectURL(cayKahveDataUrl);

                    alert('‚úÖ T√ºm deƒüi≈üiklikler JSON dosyalarƒ±na kaydedildi!\n\nƒ∞ndirilen dosyalar:\n‚Ä¢ envanter_maliyet.json\n‚Ä¢ cay_kahve_maliyet.json\n‚Ä¢ cay_kahve.json');
                } catch (error) {
                    alert('‚ùå Kaydetme hatasƒ±: ' + error.message);
                    console.error('Save error:', error);
                }
            },

            updateStats() {
                const totalProducts = this.data.products.length;
                const lowStock = this.data.products.filter(p => p.bakiye <= p.kritikSeviye).length;
                const totalCost = this.data.products.reduce((acc, p) => acc + parseFloat(p.toplamMaliyet), 0).toFixed(2);

                document.getElementById('totalProducts').textContent = totalProducts;
                document.getElementById('lowStockCount').textContent = lowStock;
                document.getElementById('totalInventoryCost').textContent = `${totalCost}‚Ç∫`;
                
                this.updateCayKahveStats();
            },

            renderInventory() {
                const tbody = document.getElementById('inventoryTable');
                tbody.innerHTML = '';
                
                let products = this.data.products;
                
                if (this.data.currentFilter === 'CRITICAL') {
                    products = products.filter(p => p.bakiye <= p.kritikSeviye);
                } else if (this.data.currentFilter === 'SEARCH') {
                    const search = document.getElementById('searchInput').value.toLowerCase();
                    products = products.filter(p => 
                        p.kod.toLowerCase().includes(search) || 
                        p.a√ßƒ±klama.toLowerCase().includes(search)
                    );
                }

                products.forEach(product => {
                    const isCritical = product.bakiye <= product.kritikSeviye;
                    let badge = '<span class="badge badge-normal">NORMAL</span>';
                    
                    if (product.bakiye <= (product.kritikSeviye * 0.5)) {
                        badge = '<span class="badge badge-critical">KRƒ∞Tƒ∞K</span>';
                    } else if (isCritical) {
                        badge = '<span class="badge badge-low">D√ú≈û√úK</span>';
                    }
                    
                    if (this._editingRow && this._editingRow.kod === product.kod) {
                        return;
                    }

                    const row = tbody.insertRow();
                    row.dataset.kod = product.kod;
                    row.id = `inv-row-${product.kod}`;
                    row.onclick = () => app.startEditInventory(product.kod);

                    row.innerHTML = `
                        <td><span style="font-family: monospace; color: #667eea; font-weight: 600;">${product.kod}</span></td>
                        <td>${product.a√ßƒ±klama}</td>
                        <td style="color: #718096;">${product.depo}</td>
                        <td style="text-align: center; font-weight: bold;">${product.bakiye}</td>
                        <td style="text-align: center; color: #38b2ac;">${product.maliyet.toFixed(2)}‚Ç∫</td>
                        <td style="text-align: center; font-weight: bold;">${product.toplamMaliyet}‚Ç∫</td>
                        <td style="text-align: center; color: ${isCritical ? '#c53030' : '#718096'};">${product.kritikSeviye}</td>
                        <td style="text-align: center;">${badge}</td>
                    `;
                });
            },

            startEditInventory(kod) {
                if (this._editingRow && this._editingRow.kod !== kod) {
                    this.cancelEdit(this._editingRow.kod);
                }
                
                const product = this.data.products.find(p => p.kod === kod);
                if (!product) return;
                
                const row = document.getElementById(`inv-row-${kod}`);
                if (!row) return;

                this._editingRow = { kod: kod };
                row.classList.add('edit-mode');
                row.onclick = null;
                
                row.innerHTML = `
                    <td colspan="4" style="background: transparent; padding: 20px;">
                        <span style="font-family: monospace; color: #667eea; font-weight: 600;">${product.kod}</span>
                        <div style="font-size: 0.9em; color: #4a5568;">${product.a√ßƒ±klama}</div>
                        <div style="font-size: 0.8em; color: #a0aec0; margin-top: 5px;">Bakiye: ${product.bakiye} / Depo: ${product.depo}</div>
                    </td>
                    <td style="background: transparent; text-align: center; padding: 10px;">
                        <input type="number" step="0.01" id="edit-cost-${kod}" value="${product.maliyet.toFixed(2)}" 
                               style="width: 100px; padding: 5px; border: 1px solid #e2e8f0; border-radius: 5px; text-align: center;">
                        <small style="color: #718096;">‚Ç∫</small>
                    </td>
                    <td style="background: transparent; text-align: center; font-weight: bold; padding: 10px;">
                        <small style="font-weight: normal; color: #a0aec0;">Hesaplanan:</small>
                        ${product.toplamMaliyet}‚Ç∫
                    </td>
                    <td style="background: transparent; text-align: center; padding: 10px;">
                        <input type="number" id="edit-critical-${kod}" value="${product.kritikSeviye}" 
                               style="width: 60px; padding: 5px; border: 1px solid #e2e8f0; border-radius: 5px; text-align: center;">
                    </td>
                    <td style="background: transparent; text-align: center; padding: 10px;">
                        <button class="btn btn-success" onclick="event.stopPropagation(); app.saveInventoryEdit('${kod}')" style="padding: 5px 10px; font-size: 0.85em; margin-right: 5px;">Kaydet</button>
                        <button class="btn" style="background: #e53e3e; padding: 5px 10px; font-size: 0.85em;" onclick="event.stopPropagation(); app.cancelEdit('${kod}')">ƒ∞ptal</button>
                    </td>
                `;
            },
            
            cancelEdit(kod) {
                this._editingRow = null;
                this.renderInventory();
            },

            saveInventoryEdit(kod) {
                const newCostInput = document.getElementById(`edit-cost-${kod}`);
                const newCriticalInput = document.getElementById(`edit-critical-${kod}`);

                if (!newCostInput || !newCriticalInput) return;

                const newCost = parseFloat(newCostInput.value);
                const newCritical = parseInt(newCriticalInput.value);
                
                const product = this.data.products.find(p => p.kod === kod);
                
                if (isNaN(newCost) || newCost < 0 || isNaN(newCritical) || newCritical < 0) {
                    alert("Ge√ßersiz deƒüerler. L√ºtfen pozitif sayƒ± girin.");
                    return;
                }
                
                let changesMade = 0;
                
                if (!this.data.envanterCost.urun_ayarlari) {
                    this.data.envanterCost.urun_ayarlari = {};
                }
                if (!this.data.envanterCost.urun_ayarlari[kod]) {
                    this.data.envanterCost.urun_ayarlari[kod] = {};
                }

                if (product.maliyet !== newCost) {
                    product.maliyet = newCost;
                    product.toplamMaliyet = (product.bakiye * newCost).toFixed(2);
                    this.data.envanterCost.urun_ayarlari[kod].maliyet = newCost;
                    changesMade++;
                }

                if (product.kritikSeviye !== newCritical) {
                    product.kritikSeviye = newCritical;
                    this.data.envanterCost.urun_ayarlari[kod].kritik_seviye = newCritical;
                    changesMade++;
                }
                
                this._editingRow = null;
                this.updateStats();
                this.renderInventory();
                
                if (changesMade > 0) {
                    alert(`‚úÖ ${product.kod} i√ßin ${changesMade} deƒüi≈üiklik kaydedildi!`);
                } else {
                    alert("Deƒüi≈üiklik yapƒ±lmadƒ±.");
                }
            },

            filterInventory(type) {
                this._editingRow = null;
                this.data.currentFilter = type;
                this.renderInventory();
            },

            resetInventoryFilter() {
                this._editingRow = null;
                this.data.currentFilter = 'ALL';
                document.getElementById('searchInput').value = '';
                this.renderInventory();
            },

            updateCayKahveStats() {
                const totalLocations = Object.keys(this.data.cayKahve).length;
                let criticalCount = 0;
                let totalCost = 0;
                
                Object.entries(this.data.cayKahve).forEach(([location, data]) => {
                    const lastRecord = data[data.length - 1];
                    let isCritical = false;
                    
                    this.cayKahveProducts.forEach(p => {
                        const stock = parseInt(lastRecord[p.label]) || 0;
                        const criticalLevel = this.getCriticalLevel(location, p.key);
                        const unitCost = this.data.cayKahveCost.urun_maliyetleri?.[p.key]?.birim_maliyet || 0;
                        
                        totalCost += stock * unitCost;
                        if (stock <= criticalLevel) isCritical = true;
                    });

                    if (isCritical) criticalCount++;
                });

                document.getElementById('totalLocations').textContent = totalLocations;
                document.getElementById('criticalLocationCount').textContent = criticalCount;
                document.getElementById('totalCayKahveCost').textContent = `${totalCost.toFixed(2)}‚Ç∫`;
            },

            getCriticalLevel(location, productKey) {
                if (this.data.cayKahveCost.kritik_seviyeler?.[location]?.[productKey] !== undefined) {
                    return this.data.cayKahveCost.kritik_seviyeler[location][productKey];
                }
                return this.data.cayKahveCost.urun_maliyetleri?.[productKey]?.varsayilan_kritik || 10;
            },

            renderCayKahveEdit() {
                const grid = document.getElementById('cayKahveEditGrid');
                grid.innerHTML = '';
                
                this.cayKahveProducts.forEach(p => {
                    const data = this.data.cayKahveCost.urun_maliyetleri?.[p.key] || { birim_maliyet: 0, varsayilan_kritik: 10 };
                    
                    const div = document.createElement('div');
                    div.className = 'edit-item';
                    div.innerHTML = `
                        <label>${p.key} (Varsayƒ±lan)</label>
                        <div style="margin-bottom: 10px;">
                            <small style="color: #a0aec0;">Birim Maliyet (‚Ç∫)</small>
                            <input type="number" step="0.01" data-key="${p.key}" data-type="cost" value="${data.birim_maliyet}" style="margin-top: 5px;">
                        </div>
                        <div>
                            <small style="color: #a0aec0;">Varsayƒ±lan Kritik Seviye</small>
                            <input type="number" data-key="${p.key}" data-type="critical" value="${data.varsayilan_kritik}" style="margin-top: 5px;">
                        </div>
                    `;
                    grid.appendChild(div);
                });
            },

            saveCayKahveSettings() {
                let count = 0;
                const inputs = document.querySelectorAll('#cayKahveEditGrid input');
                
                if (!this.data.cayKahveCost.urun_maliyetleri) {
                    this.data.cayKahveCost.urun_maliyetleri = {};
                }
                
                inputs.forEach(input => {
                    const key = input.dataset.key;
                    const type = input.dataset.type;
                    
                    if (!this.data.cayKahveCost.urun_maliyetleri[key]) {
                        this.data.cayKahveCost.urun_maliyetleri[key] = { birim: 'Adet' };
                    }
                    
                    if (type === 'cost') {
                        const val = parseFloat(input.value);
                        if (!isNaN(val) && val >= 0) {
                            this.data.cayKahveCost.urun_maliyetleri[key].birim_maliyet = val;
                            count++;
                        }
                    } else if (type === 'critical') {
                        const val = parseInt(input.value);
                        if (!isNaN(val) && val >= 0) {
                            this.data.cayKahveCost.urun_maliyetleri[key].varsayilan_kritik = val;
                            count++;
                        }
                    }
                });

                this.updateCayKahveStats();
                this.renderAllLocations();
                alert(`‚úÖ ${count} varsayƒ±lan ayar deƒüi≈üikliƒüi kaydedildi!`);
            },

            populateLocationSelect() {
                const select = document.getElementById('locationSelect');
                Object.keys(this.data.cayKahve).forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    option.textContent = location;
                    select.appendChild(option);
                });
            },

            renderAllLocations() {
                const container = document.getElementById('allLocations');
                container.innerHTML = '';
                
                let locations = Object.entries(this.data.cayKahve);
                
                if (this.data.cayKahveFilter === 'CRITICAL') {
                    locations = locations.filter(([location, data]) => {
                        const lastRecord = data[data.length - 1];
                        return this.cayKahveProducts.some(p => {
                            const stock = parseInt(lastRecord[p.label]) || 0;
                            const criticalLevel = this.getCriticalLevel(location, p.key);
                            return stock <= criticalLevel;
                        });
                    });
                }

                locations.forEach(([location, data]) => {
                    const lastRecord = data[data.length - 1];
                    const card = document.createElement('div');
                    card.className = 'location-card';
                    
                    card.onclick = () => {
                        document.getElementById('locationSelect').value = location;
                        app.changeLocation();
                    };

                    let totalCost = 0;
                    let isAnyCritical = false;
                    let content = `<h3>${location}</h3>`;
                    
                    this.cayKahveProducts.forEach(p => {
                        const stock = parseInt(lastRecord[p.label]) || 0;
                        const criticalLevel = this.getCriticalLevel(location, p.key);
                        const unitCost = this.data.cayKahveCost.urun_maliyetleri?.[p.key]?.birim_maliyet || 0;
                        const cost = stock * unitCost;
                        totalCost += cost;
                        
                        const isCritical = stock <= criticalLevel;
                        if (isCritical) isAnyCritical = true;
                        
                        content += `
                            <div class="location-item">
                                <span class="label">${p.key}:</span>
                                <span class="value" style="color: ${isCritical ? '#c53030' : '#2d3748'};">
                                    ${stock} ${isCritical ? '<span class="critical-badge">KRƒ∞Tƒ∞K (' + criticalLevel + ')</span>' : ''}
                                    <div style="font-size: 0.8em; color: #a0aec0; margin-top: 3px; font-weight: normal;">
                                        ${unitCost.toFixed(2)}‚Ç∫ √ó ${stock} = <strong style="color: #38b2ac;">${cost.toFixed(2)}‚Ç∫</strong>
                                    </div>
                                </span>
                            </div>
                        `;
                    });
                    
                    content += `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #718096; font-weight: 600;">Toplam Maliyet:</span>
                                <span style="color: #38b2ac; font-size: 1.3em; font-weight: bold;">${totalCost.toFixed(2)}‚Ç∫</span>
                            </div>
                        </div>
                    `;
                    
                    card.innerHTML = content;
                    card.style.borderLeft = `5px solid ${isAnyCritical ? '#fc8181' : '#48bb78'}`;
                    container.appendChild(card);
                });
                
                if (locations.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 20px; color: #718096;">Kritik lokasyon bulunamadƒ±.</p>';
                }
            },

            changeLocation() {
                const location = document.getElementById('locationSelect').value;
                
                if (location === 'ALL') {
                    document.getElementById('allLocations').classList.remove('hidden');
                    document.getElementById('singleLocation').classList.add('hidden');
                    this.renderAllLocations();
                } else {
                    document.getElementById('allLocations').classList.add('hidden');
                    document.getElementById('singleLocation').classList.remove('hidden');
                    this.renderLocationDetail(location);
                }
            },

            renderLocationDetail(location) {
                const data = this.data.cayKahve[location];
                const lastRecord = data[data.length - 1];
                const container = document.getElementById('locationDetail');
                
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">';
                
                this.cayKahveProducts.forEach(p => {
                    const stock = parseInt(lastRecord[p.label]) || 0;
                    const criticalLevel = this.getCriticalLevel(location, p.key);
                    const unitCost = this.data.cayKahveCost.urun_maliyetleri?.[p.key]?.birim_maliyet || 0;
                    const totalCost = stock * unitCost;
                    const isCritical = stock <= criticalLevel;
                    
                    html += `
                        <div style="background: #f7fafc; padding: 20px; border-radius: 10px; border-left: 5px solid ${isCritical ? '#fc8181' : '#48bb78'};">
                            <h4 style="color: #718096; margin-bottom: 10px;">${p.key}</h4>
                            <div style="font-size: 2em; font-weight: bold; color: ${isCritical ? '#c53030' : '#2d3748'}; margin-bottom: 5px;">
                                ${stock} ${isCritical ? '<span class="critical-badge">KRƒ∞Tƒ∞K</span>' : ''}
                            </div>
                            <div style="font-size: 0.85em; color: #a0aec0;">Son G√ºncelleme: ${lastRecord[p.dateKey] || '-'}</div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                                <div style="font-size: 0.85em; color: #718096;">
                                    Birim Maliyet: ${unitCost.toFixed(2)}‚Ç∫<br>
                                    <strong style="color: #38b2ac;">Toplam Maliyet: ${totalCost.toFixed(2)}‚Ç∫</strong>
                                </div>
                                
                                <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #e2e8f0;">
                                    <label style="font-size: 0.85em; display: block; margin-bottom: 5px;">üì¶ Stok D√ºzenle:</label>
                                    <input type="number" id="stock-adjust-${location}-${p.key}" placeholder="Yeni Miktar" style="width: 100px; padding: 5px; border: 1px solid #e2e8f0; border-radius: 5px;">
                                    <button class="btn btn-success" onclick="app.saveLocationStock('${location}', '${p.key}')" style="padding: 5px 10px; font-size: 0.85em; margin-left: 5px;">Kaydet</button>
                                </div>

                                <div style="margin-top: 10px;">
                                    <label style="font-size: 0.85em; display: block; margin-bottom: 5px;">üö® Kritik Seviye:</label>
                                    <input type="number" id="crit-${location}-${p.key}" value="${criticalLevel}" style="width: 70px; padding: 5px; border: 1px solid #e2e8f0; border-radius: 5px;">
                                    <button class="btn btn-primary" onclick="app.saveLocationCritical('${location}', '${p.key}')" style="padding: 5px 10px; font-size: 0.85em; margin-left: 5px;">Kaydet</button>
                                    <small style="color: #a0aec0; display: block; margin-top: 5px;">Varsayƒ±lan: ${this.data.cayKahveCost.urun_maliyetleri?.[p.key]?.varsayilan_kritik || 10}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                html += `
                    <div style="margin-top: 30px; background: #f7fafc; padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px; color: #2d3748;">Teslimat Ge√ßmi≈üi</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; background: white; border-radius: 10px; overflow: hidden;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 10px;">#</th>
                                        ${this.cayKahveProducts.map(p => `<th style="padding: 10px;">${p.key}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${[...data].reverse().map((record, i) => `
                                        <tr style="border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 10px; font-weight: 600;">${data.length - i}</td>
                                            ${this.cayKahveProducts.map(p => `
                                                <td style="padding: 10px;">
                                                    <div style="font-weight: 600;">${record[p.label] || '-'}</div>
                                                    <div style="font-size: 0.85em; color: #a0aec0;">${record[p.dateKey] || '-'}</div>
                                                </td>
                                            `).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            },

            saveLocationStock(location, productKey) {
                const input = document.getElementById(`stock-adjust-${location}-${productKey}`);
                const newStock = parseInt(input.value);
                
                if (isNaN(newStock) || newStock < 0) {
                    alert("L√ºtfen ge√ßerli ve pozitif bir stok miktarƒ± girin.");
                    return;
                }
                
                const dataArray = this.data.cayKahve[location];
                if (!dataArray || dataArray.length === 0) {
                    alert("Lokasyon verisi bulunamadƒ±.");
                    return;
                }
                
                const lastRecord = { ...dataArray[dataArray.length - 1] };
                const now = new Date();
                const dateString = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                
                const product = this.cayKahveProducts.find(p => p.key === productKey);
                
                lastRecord[product.label] = newStock.toString();
                lastRecord[product.dateKey] = dateString;
                
                dataArray.push(lastRecord);
                
                input.value = '';
                
                this.updateCayKahveStats();
                this.renderLocationDetail(location);
                
                alert(`‚úÖ ${location} i√ßin ${productKey} stoku ${newStock} olarak g√ºncellendi!`);
            },

            saveLocationCritical(location, productKey) {
                const input = document.getElementById(`crit-${location}-${productKey}`);
                const val = parseInt(input.value);
                
                if (!this.data.cayKahveCost.kritik_seviyeler) {
                    this.data.cayKahveCost.kritik_seviyeler = {};
                }
                
                const defaultValue = this.data.cayKahveCost.urun_maliyetleri?.[productKey]?.varsayilan_kritik || 10;
                
                if (isNaN(val) || val < 0 || val === defaultValue) {
                    if (this.data.cayKahveCost.kritik_seviyeler[location]) {
                        delete this.data.cayKahveCost.kritik_seviyeler[location][productKey];
                        if (Object.keys(this.data.cayKahveCost.kritik_seviyeler[location]).length === 0) {
                            delete this.data.cayKahveCost.kritik_seviyeler[location];
                        }
                    }
                    input.value = defaultValue;
                    alert(`‚úÖ √ñzel seviye kaldƒ±rƒ±ldƒ±. Varsayƒ±lan (${defaultValue}) kullanƒ±lacak.`);
                } else {
                    if (!this.data.cayKahveCost.kritik_seviyeler[location]) {
                        this.data.cayKahveCost.kritik_seviyeler[location] = {};
                    }
                    this.data.cayKahveCost.kritik_seviyeler[location][productKey] = val;
                    alert(`‚úÖ ${location} - ${productKey} kritik seviyesi ${val} olarak g√ºncellendi!`);
                }
                
                this.updateCayKahveStats();
                this.renderLocationDetail(location);
            },

            filterCayKahve(type) {
                this.data.cayKahveFilter = type;
                document.getElementById('locationSelect').value = 'ALL';
                this.changeLocation();
            },

            resetCayKahveFilter() {
                this.data.cayKahveFilter = 'ALL';
                document.getElementById('locationSelect').value = 'ALL';
                this.changeLocation();
            },

            switchTab(tab, event) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                document.getElementById('envanterTab').classList.toggle('hidden', tab !== 'envanter');
                document.getElementById('cayKahveTab').classList.toggle('hidden', tab !== 'cayKahve');
                
                if (this._editingRow) {
                    this.cancelEdit(this._editingRow.kod);
                }

                if (tab === 'cayKahve') {
                    this.updateCayKahveStats();
                    this.changeLocation();
                }
            }
        };

        window.onload = () => app.loadData();
    </script>
</body>
</html>